{% extends "base.html" %}

{% block title %}Edit My Schedule - Smart Timetable{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-edit me-2 text-primary"></i>
                        Edit My Teaching Schedule
                    </h2>
                    <p class="text-muted mb-0">Click on any time slot to edit your schedule</p>
                </div>
                <div>
                    <a href="{{ url_for('teacher.dashboard') }}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-1"></i>Dashboard
                    </a>
                    <button type="button" class="btn btn-warning me-2" onclick="optimizeSchedule()">
                        <i class="fas fa-magic me-1"></i>AI Optimize
                    </button>
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('teacher.download_timetable', format='csv') }}" class="btn btn-success">
                            <i class="fas fa-download me-1"></i>CSV
                        </a>
                        <a href="{{ url_for('teacher.download_timetable', format='excel') }}" class="btn btn-primary">
                            <i class="fas fa-file-excel me-1"></i>Excel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Optimization Status -->
    <div id="optimization-status" class="alert alert-info" style="display: none;">
        <i class="fas fa-cog fa-spin me-2"></i>
        <span id="optimization-message">Running AI optimization...</span>
    </div>

    <!-- Editable Timetable Grid -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>
                            Editable Weekly Schedule
                            <span class="badge bg-primary ms-2">{{ total_slots }} Classes</span>
                        </h5>
                        <div>
                            <span class="badge bg-success me-2">Click to Edit</span>
                            <span class="badge bg-warning">AI Optimized</span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover mb-0" id="timetable-grid">
                            <thead class="table-dark">
                                <tr>
                                    <th>Day/Time</th>
                                    <th>08:00-09:00</th>
                                    <th>09:00-10:00</th>
                                    <th>10:00-11:00</th>
                                    <th>11:20-12:20</th>
                                    <th>13:00-14:00</th>
                                    <th>14:00-15:00</th>
                                    <th>15:00-16:00</th>
                                    <th>16:00-17:00</th>
                                    <th>17:00-18:00</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for day in days %}
                                <tr>
                                    <td class="fw-bold bg-light">{{ day }}</td>
                                    {% for time_start, time_end in time_slots %}
                                    {% set slot = slots|selectattr('day', 'equalto', day)|selectattr('time_start', 'equalto', time_start)|first %}
                                    <td class="p-1">
                                        {% if slot %}
                                        <div class="slot-card border rounded p-2 bg-info text-white editable-slot" 
                                             style="min-height: 80px; cursor: pointer;"
                                             data-slot-id="{{ slot.id }}"
                                             data-day="{{ day }}"
                                             data-time-start="{{ time_start }}"
                                             data-time-end="{{ time_end }}"
                                             onclick="editSlot(this)">
                                            <small class="fw-bold">{{ slot.subject_code }}</small><br>
                                            <small>{{ slot.subject_name[:15] }}{% if slot.subject_name|length > 15 %}...{% endif %}</small><br>
                                            <small>{{ slot.batch_id }} - {{ slot.section }}</small><br>
                                            <small>{{ slot.room_id }} ({{ slot.campus }})</small><br>
                                            <small class="text-warning"><i class="fas fa-edit"></i> Click to edit</small>
                                        </div>
                                        {% else %}
                                        <div class="empty-slot border border-dashed rounded p-2 text-center text-muted editable-slot" 
                                             style="min-height: 80px; cursor: pointer;"
                                             data-day="{{ day }}"
                                             data-time-start="{{ time_start }}"
                                             data-time-end="{{ time_end }}"
                                             onclick="addNewSlot(this)">
                                            <i class="fas fa-plus-circle mb-1"></i><br>
                                            <small>Add Class</small>
                                        </div>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h3 class="text-primary">{{ total_slots }}</h3>
                    <small class="text-muted">Total Classes</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h3 class="text-success">{{ subjects|length }}</h3>
                    <small class="text-muted">Subjects Teaching</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h3 class="text-warning">{{ slots|map(attribute='batch_id')|unique|list|length }}</h3>
                    <small class="text-muted">Different Batches</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h3 class="text-info">{{ rooms|length }}</h3>
                    <small class="text-muted">Available Rooms</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Slot Modal -->
<div class="modal fade" id="editSlotModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>
                    Edit Time Slot
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editSlotForm">
                    <input type="hidden" id="slotId" name="slot_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Day</label>
                                <input type="text" class="form-control" id="slotDay" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Time</label>
                                <input type="text" class="form-control" id="slotTime" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Subject</label>
                                <select class="form-select" id="subjectCode" name="subject_code" required>
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.subject_code }}">{{ subject.subject_code }} - {{ subject.subject_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Room</label>
                                <select class="form-select" id="roomId" name="room_id" required>
                                    <option value="">Select Room</option>
                                    {% for room in rooms %}
                                    <option value="{{ room.room_id }}">{{ room.room_id }} - {{ room.room_name }} ({{ room.campus }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Batch ID</label>
                                <input type="text" class="form-control" id="batchId" name="batch_id" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Section</label>
                                <input type="text" class="form-control" id="section" name="section" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Activity Type</label>
                                <select class="form-select" id="activityType" name="activity_type" required>
                                    <option value="Lecture">Lecture</option>
                                    <option value="Lab">Lab</option>
                                    <option value="Tutorial">Tutorial</option>
                                    <option value="Practical">Practical</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteSlotBtn" onclick="deleteSlot()">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
                <button type="button" class="btn btn-primary" onclick="saveSlot()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentSlotElement = null;
let editModal = null;

// Initialize modal when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    editModal = new bootstrap.Modal(document.getElementById('editSlotModal'));
});

function editSlot(element) {
    console.log('EditSlot called with element:', element);
    currentSlotElement = element;
    const slotId = element.dataset.slotId;
    const day = element.dataset.day;
    const timeStart = element.dataset.timeStart;
    const timeEnd = element.dataset.timeEnd;
    
    console.log('Slot data:', {slotId, day, timeStart, timeEnd});
    
    // Populate modal with current values
    document.getElementById('slotId').value = slotId || '';
    document.getElementById('slotDay').value = day;
    document.getElementById('slotTime').value = timeStart + ' - ' + timeEnd;
    
    if (slotId) {
        console.log('Fetching slot data for ID:', slotId);
        // Fetch current slot data and populate form
        fetch(`/teacher/slot/${slotId}`, {
            headers: { 'Accept': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Received slot data:', data);
            if (data.slot) {
                document.getElementById('subjectCode').value = data.slot.subject_code;
                document.getElementById('roomId').value = data.slot.room_id;
                document.getElementById('batchId').value = data.slot.batch_id;
                document.getElementById('section').value = data.slot.section;
                document.getElementById('activityType').value = data.slot.activity_type;
                document.getElementById('deleteSlotBtn').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error fetching slot data:', error);
        });
    } else {
        console.log('No slot ID, setting up for new slot');
        // Clear form for new slot
        document.getElementById('editSlotForm').reset();
        document.getElementById('slotId').value = '';
        document.getElementById('slotDay').value = day;
        document.getElementById('slotTime').value = timeStart + ' - ' + timeEnd;
        document.getElementById('deleteSlotBtn').style.display = 'none';
    }
    
    console.log('Attempting to show modal, editModal:', editModal);
    if (editModal) {
        editModal.show();
        console.log('Modal show() called');
    } else {
        console.error('Modal not initialized!');
        // Fallback - try to initialize and show modal
        try {
            const modalElement = document.getElementById('editSlotModal');
            if (modalElement) {
                editModal = new bootstrap.Modal(modalElement);
                editModal.show();
                console.log('Modal created and shown via fallback');
            }
        } catch (e) {
            console.error('Fallback modal creation failed:', e);
        }
    }
}

function addNewSlot(element) {
    editSlot(element);
}

function saveSlot() {
    const form = document.getElementById('editSlotForm');
    const formData = new FormData(form);
    const slotId = document.getElementById('slotId').value;
    
    // Add day and time data
    formData.append('day', currentSlotElement.dataset.day);
    formData.append('time_start', currentSlotElement.dataset.timeStart);
    formData.append('time_end', currentSlotElement.dataset.timeEnd);
    
    const url = slotId ? `/teacher/slot/${slotId}` : '/teacher/slot/new';
    const method = slotId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            editModal.hide();
            showToast('Slot saved successfully!', 'success');
            // Refresh the slot display
            updateSlotDisplay(currentSlotElement, data.slot);
        } else {
            showToast(data.message || 'Error saving slot', 'error');
        }
    })
    .catch(error => {
        showToast('Error saving slot: ' + error.message, 'error');
    });
}

function deleteSlot() {
    const slotId = document.getElementById('slotId').value;
    if (!slotId) return;
    
    if (confirm('Are you sure you want to delete this slot?')) {
        fetch(`/teacher/slot/${slotId}`, {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                editModal.hide();
                showToast('Slot deleted successfully!', 'success');
                // Clear the slot display
                clearSlotDisplay(currentSlotElement);
            } else {
                showToast(data.message || 'Error deleting slot', 'error');
            }
        })
        .catch(error => {
            showToast('Error deleting slot: ' + error.message, 'error');
        });
    }
}

function optimizeSchedule() {
    const statusDiv = document.getElementById('optimization-status');
    const messageSpan = document.getElementById('optimization-message');
    
    statusDiv.style.display = 'block';
    statusDiv.className = 'alert alert-info';
    messageSpan.textContent = 'Running AI optimization...';
    
    fetch('/teacher/timetable/optimize', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.className = 'alert alert-success';
            messageSpan.innerHTML = '<i class="fas fa-check me-2"></i>' + data.message;
            showToast('Schedule optimized successfully!', 'success');
            // Optionally reload the page to show optimized results
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            statusDiv.className = 'alert alert-danger';
            messageSpan.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + data.message;
            showToast('Optimization failed: ' + data.message, 'error');
        }
    })
    .catch(error => {
        statusDiv.className = 'alert alert-danger';
        messageSpan.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Optimization failed';
        showToast('Optimization error: ' + error.message, 'error');
    });
}

function updateSlotDisplay(element, slotData) {
    element.innerHTML = `
        <small class="fw-bold">${slotData.subject_code}</small><br>
        <small>${slotData.subject_name.substring(0, 15)}${slotData.subject_name.length > 15 ? '...' : ''}</small><br>
        <small>${slotData.batch_id} - ${slotData.section}</small><br>
        <small>${slotData.room_id} (${slotData.campus})</small><br>
        <small class="text-warning"><i class="fas fa-edit"></i> Click to edit</small>
    `;
    element.className = 'slot-card border rounded p-2 bg-info text-white editable-slot';
    element.style.minHeight = '80px';
    element.style.cursor = 'pointer';
    element.dataset.slotId = slotData.id;
    element.onclick = () => editSlot(element);
}

function clearSlotDisplay(element) {
    element.innerHTML = `
        <i class="fas fa-plus-circle mb-1"></i><br>
        <small>Add Class</small>
    `;
    element.className = 'empty-slot border border-dashed rounded p-2 text-center text-muted editable-slot';
    element.style.minHeight = '80px';
    element.style.cursor = 'pointer';
    delete element.dataset.slotId;
    element.onclick = () => addNewSlot(element);
}

function showToast(message, type) {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}